# Архитектура проекта: Симулятор броска костей на ESP32 с дисплеем ST7735

## Обзор проекта

Проект реализует симулятор броска двух игральных кубиков (костей) на микроконтроллере ESP32 с использованием TFT-дисплея ST7735 (128x128, 1.44"). Каждые 10 секунд на экране отображаются два кубика с случайными значениями от 1 до 6.

## Технический стек

- **Платформа**: ESP32 (ESP32-DEVKIT)
- **Дисплей**: ST7735 TFT LCD 128x128px, 1.44"
- **Фреймворк**: Arduino
- **Среда разработки**: PlatformIO (Visual Studio Code)
- **Библиотеки**:
  - Adafruit GFX Library (графические примитивы)
  - Adafruit ST7735 and ST7789 Library (драйвер дисплея)

## Схема подключения

### Пины дисплея ST7735 → ESP32

| ST7735 Pin | ESP32 Pin | Назначение |
|------------|-----------|------------|
| VCC        | 3.3V      | Питание    |
| GND        | GND       | Земля      |
| CS         | GPIO 5    | Chip Select (SPI) |
| RESET      | GPIO 4    | Сброс дисплея |
| A0 (DC)    | GPIO 2    | Data/Command |
| SDA (MOSI) | GPIO 23   | Master Out Slave In (SPI) |
| SCK (SCLK) | GPIO 18   | Serial Clock (SPI) |
| LED        | 3.3V      | Подсветка (через резистор 220Ω) |

## Архитектура программы

```
┌─────────────────────────────────────────┐
│           main.cpp                      │
├─────────────────────────────────────────┤
│                                         │
│  ┌───────────────────────────────┐     │
│  │   setup()                     │     │
│  │  • Инициализация Serial       │     │
│  │  • Инициализация дисплея      │     │
│  │  • Настройка генератора       │     │
│  │    случайных чисел            │     │
│  │  • Очистка экрана             │     │
│  └───────────────────────────────┘     │
│                                         │
│  ┌───────────────────────────────┐     │
│  │   loop()                      │     │
│  │  • Генерация 2 случайных      │     │
│  │    чисел (1-6)                │     │
│  │  • Очистка экрана             │     │
│  │  • Отрисовка кубика 1         │     │
│  │  • Отрисовка кубика 2         │     │
│  │  • Задержка 10 секунд         │     │
│  └───────────────────────────────┘     │
│                                         │
│  ┌───────────────────────────────┐     │
│  │   drawDice(x, y, value)       │     │
│  │  • Рисование квадрата         │     │
│  │  • Рисование точек по         │     │
│  │    паттерну значения          │     │
│  └───────────────────────────────┘     │
│                                         │
└─────────────────────────────────────────┘
```

## Детали реализации

### 1. Функция `drawDice(x, y, value)`

Отрисовывает один кубик с заданным значением.

**Параметры:**
- `x, y` - координаты верхнего левого угла кубика
- `value` - значение кубика (1-6)

**Размеры:**
- Размер кубика: 50x50 пикселей
- Радиус закругления углов: 8 пикселей
- Радиус точек: 4 пикселя
- Цвета: белый фон, черные точки, черная рамка

**Паттерны точек для значений:**

```
  1: центр          2: диагональ      3: диагональ + центр
  ┌────────┐        ┌────────┐        ┌────────┐
  │        │        │ ●      │        │ ●      │
  │   ●    │        │        │        │   ●    │
  │        │        │      ● │        │      ● │
  └────────┘        └────────┘        └────────┘

  4: углы           5: углы + центр   6: два столбца
  ┌────────┐        ┌────────┐        ┌────────┐
  │ ●    ● │        │ ●    ● │        │ ●    ● │
  │        │        │   ●    │        │ ●    ● │
  │ ●    ● │        │ ●    ● │        │ ●    ● │
  └────────┘        └────────┘        └────────┘
```

### 2. Инициализация дисплея

```cpp
// Инициализация с правильным режимом
tft.initR(INITR_REDTAB);  // или INITR_BLACKTAB в зависимости от партии

// Поворот экрана (опционально)
tft.setRotation(2);  // переворот на 180° если требуется

// Очистка экрана
tft.fillScreen(ST7735_BLACK);
```

### 3. Генератор случайных чисел

```cpp
// Инициализация в setup()
randomSeed(analogRead(0));  // Используем шум с несвязанного пина

// Использование в loop()
int dice1 = random(1, 7);  // 1-6
int dice2 = random(1, 7);  // 1-6
```

### 4. Расположение кубиков на экране

Для дисплея 128x128 пикселей:
- Первый кубик: x=14, y=39 (левее центра)
- Второй кубик: x=64, y=39 (правее центра)
- Расстояние между кубиками: 50 пикселей

```
┌──────────────────────────────┐ 0
│                              │
│        ┌────┐  ┌────┐        │ 39
│        │ D1 │  │ D2 │        │
│        └────┘  └────┘        │
│      14       64             │
│                              │
└──────────────────────────────┘ 128
0                             128
```

## Конфигурация PlatformIO

### platformio.ini

```ini
[env:esp32dev]
platform = espressif32
board = esp32dev
framework = arduino
monitor_speed = 115200
upload_speed = 115200
lib_deps = 
    adafruit/Adafruit GFX Library@^1.11.9
    adafruit/Adafruit ST7735 and ST7789 Library@^1.10.3
```

## Поток выполнения программы

```
START
  │
  ├─> setup()
  │    ├─> Инициализация Serial (115200)
  │    ├─> Инициализация SPI дисплея
  │    ├─> Настройка randomSeed()
  │    └─> Очистка экрана (черный фон)
  │
  └─> loop() ←─────┐
       │           │
       ├─> Генерация dice1 (1-6)
       ├─> Генерация dice2 (1-6)
       ├─> Очистка экрана
       ├─> drawDice(14, 39, dice1)
       ├─> drawDice(64, 39, dice2)
       ├─> delay(10000) // 10 секунд
       │           │
       └───────────┘
```

## Особенности реализации

### 1. Использование аппаратного SPI
Используются стандартные пины ESP32 для аппаратного SPI, что обеспечивает максимальную скорость обновления дисплея.

### 2. Оптимизация отрисовки
- Полная очистка экрана перед каждым обновлением
- Использование fillRoundRect() для кубиков с закругленными углами
- Использование fillCircle() для точек

### 3. Генерация случайных чисел
Используется analogRead() с несвязанного пина для инициализации генератора случайных чисел, обеспечивая непредсказуемость результатов.

## Возможные расширения

1. **Анимация броска** - плавное изменение значений перед остановкой
2. **Звук** - добавление buzzer для звукового эффекта броска
3. **Кнопка** - ручной запуск броска вместо автоматического таймера
4. **Статистика** - отображение суммы кубиков или истории бросков
5. **Настройка времени** - изменение интервала обновления

## Требования к тестированию

1. ✓ Корректная инициализация дисплея
2. ✓ Правильное отображение всех значений кубиков (1-6)
3. ✓ Случайность генерации чисел
4. ✓ Соблюдение интервала 10 секунд
5. ✓ Отсутствие артефактов на экране
6. ✓ Стабильная работа в течение длительного времени

## Заключение

Данная архитектура обеспечивает простую, но функциональную реализацию симулятора броска костей с возможностью дальнейшего расширения функционала.